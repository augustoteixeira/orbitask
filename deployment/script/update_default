set -e  # Exit on error
set -o pipefail

VPS_USER=youruser
VPS_HOST=your.vps.ip.or.domain
REMOTE_DIR=/opt/orbitask
REMOTE_BIN="$REMOTE_DIR/backend"
LOCAL_BIN=backend/target/release/backend

echo "Compiling release"

(cd ../../backend; cargo build --release)

echo "ğŸš€ Starting deployment to $VPS_HOST"

# Create remote directory
echo "ğŸ“ Ensuring remote directory exists..."
ssh "$VPS_USER@$VPS_HOST" "mkdir -p '$REMOTE_DIR'" || {
    echo "âŒ Failed to create remote directory"
    exit 1
}

# Stop supervisor task first
echo "ğŸ›‘ Stopping orbitask service..."
ssh "$VPS_USER@$VPS_HOST" "sudo supervisorctl stop orbitask" || {
    echo "âŒ Failed to stop orbitask with supervisor"
    exit 1
}

# Copy the binary
echo "ğŸ“¤ Uploading new binary..."
scp "$LOCAL_BIN" "$VPS_USER@$VPS_HOST:$REMOTE_BIN" || {
    echo "âŒ Failed to upload binary"
    exit 1
}

# Set correct permissions just in case
echo "ğŸ” Setting executable permission..."
ssh "$VPS_USER@$VPS_HOST" "chmod +x '$REMOTE_BIN'"

# Restart the service
echo "âœ… Restarting orbitask service..."
ssh "$VPS_USER@$VPS_HOST" "sudo supervisorctl start orbitask" || {
    echo "âŒ Failed to start orbitask with supervisor"
    exit 1
}

# Confirm itâ€™s running
echo "ğŸ” Checking service status:"
ssh "$VPS_USER@$VPS_HOST" "sudo supervisorctl status orbitask"

echo "ğŸ‰ Deployment complete!"
